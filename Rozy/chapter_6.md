# chapter 6 키-값 저장소 설계

- 비 관계형(non-relational) 데이터베이스
- 키-값 쌍에서 키는 유일, 키를 통해서만 접근 가능
- 키: 일반 텍스트 or 해시값
- 키는 짧을수록 성능에 좋다

분산 키-값 저장소가 가져야 하는 기능! 
## 대규모 데이터 저장
- 많은 데이터를 저장하려면 분산 키-값 저장소를 만들어야 함
- CAP: 일관성, 가용성, 파티션 감내 라는 세가지 요구사항 중 두개를 만족도록 시스템 설계
- C(consistency): 일관성 - 어떤 노드에 접속해도 언제나 같은 데이터를 보게됨
- A(availability): 가용성 - 일부 노드에 장애 발생해도 클라이언트는 항상 응답 받을 수 있어야 함
- P(partition tolerance): 파티션 감내 - 두 노드 사이에 통신장애 발생 -> 네트워크에 파티션이 생기더라도 시스템은 계속 동작해야 함
- **안정 해시를 사용해 서버들에 부하 분산**

## 읽기 연산에 대한 높은 가용성 보장
- 데이터를 N개 서버에 비동기적으로 다중화
- 안정 해시
- 키가 해시 링에서 시계방향으로 링을 순회하면서 만나는 첫 N개 서버에 데이터 사본을 보관
- 가상 노드를 사용한다면, N개의 노드 = N개의 서버 가 아닐 수 있기 때문에 실제 물리 서버의 개수가 N개 보다 작아질 수 있다
- 따라서 같은 물리 서버를 중복 선택하지 않도록 해야 한다

## 쓰기 연산에 대한 높은 가용성 보장
- 데이터를 다중화하면 가용성은 높아지지만, 사본 간 일관성은 깨진다
- 강한 일관성: 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환
- 약한 일관성: 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다
- 최종 일관성: 약한 일관성의 한 형태, 갱신 결과가 결국에는 모든 사본에 반영
- 일관성이 깨진 데이터를 읽지 않도록 하기 위해서는..
1. 버저닝
- 데이터를 변경할 때마다 해당 데이터의 새로운 버전을 만드는 것
- 각 버전의 데이터는 변경 불가능
- 최신의 버전 두개가 다른 연산이라면 충돌 발생
2. 백터 시계
- 충돌을 발견하고 자동으로 해결해 낼 버저닝 시스템
- 어떤 버전이 선행, 후행인지, 충돌이 있는지 판별
- 충돌은 클라이언트가 해소한 후에 서버에 기록
- 그러나, 로직이 클라이언트에 들어가 구현이 복잡해지고 / 버전의 순서쌍 개수가 빠르게 증가

## 장애처리
### 일시적 장애처리
- 가십 프로토콜로 장애를 감지한 시스템은 가용성을 보장하기 위해 필요한 조치를 해야함
  - 가십 프로토콜: 분산형 장애 감지
  - 각 노드는 주기적으로 박동 카운터를 증가 -> 박동 카운터 값이 갱신되지 않으면 그 멤버는 장애 상태인것으로 간주
- 엄격한 정족수는 장애가 발생하면 읽기와 쓰기 연산이 금지되어 조절 불가능
- **느슨한 정족수**는 일관성 조절 가능
  - 정족수 요구사항을 강제하는 대신, 쓰기 연산을 수행할 W개의 서버와 / 읽기 연산을 수행할 R개의 서버를 해시링에서 고른다
  - 장애 서버로 가는 요청은 다른 서버가 잠시 처리
  - 서버가 복구되었을 때 지금까지 있었던 데이터 변경사항을 일괄 반영 -> 데이터 일관성 결국은 보존

### 영구적 장애처리
- 영구적 노드의 장애 상태를 해결하기 위해서는 '반-엔트로피 프로토콜-사본들을 비교하여 최신 버전으로 갱신'
- 사본간의 망가진 일관성을 탐지하고, 전송 데이터의 양을 줄이기 위해서는 **머클트리** 사용
  - 머클트리: 키 공간을 버킷으로 나누고 해시 함수를 적용해 해시 값을 계산 -> 해당 해시값을 레이블로 갖는 노드를 만들어 나가며 트리 상향식으로 구성
  - 루트 노드의 해시값을 비교하여 서버간에 다른 데이터 값을 갖는 것을 알 수 있다
  - 아래쪽(왼쪽 자식 노드->오른쪽 자식 노드)으로 탐색해 나가면서 다른 데이터를 갖는 버킷 발견
  - 그 버킷만 동기화 하면 된다

## 데이터 센터 장애 대응
- 데이터를 여러 데이터 센터에 다중화 해야 함

@ 느낀점: 왜 알고리즘이 필요하고, 공부해야 하는건지 드디어 조금은 와닿는 시간이었다.

컴퓨터를 어떻게 수학적으로 계산하게 할것인가.. 를 설계하기 위해 어떤 공식을 사용하면 좋을지 알려면 알고리즘을 알아야 되는거구나! 라고 생각이 들었다.

# 논의주제
글로벌 서비스를 만들고 있는 알비언의 경우, 해외의 데이터센터와 우리나라 데이터 센터가 있다고 가정했을 때,
나라별로 많이 쓰이는 데이터가 다를텐데, 그럼 나라별로 데이터를 분산 기준이 달라지게 되는걸까?