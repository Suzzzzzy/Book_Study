# chapter 5 안정 해시 설계
수평적 규모를 확장하기 위해서는 요청 or 데이터를 서버에 균등하게 나누어야 함 -> 이 목표를 달성하기 위해 사용하는 기술

**안정해시**가 풀려는 문제는 다음과 같다.

**"해시 키 재배치 문제"**
- 예를 들어 4개의 서버를 사용할때, 각각의 키에 대해서 해시값과 서버 인덱스를 계산
- 서버 한개가 장애를 일으켜 중단될 경우 키에대한 해시값은 변하지 않지만 인덱스가 변한다
- 그러면 캐시 클라이언트가 엉뚱한 서버에 접속
- -> 대규모 캐시 미스 발생

## 해시링
### 서버 조회
키가 저장되는 서버는, 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫번째 서버

### 서버 추가
- 키 가운데 일부만 재배치
- 키는 시계 방향으로 링을 탐색해 서버를 찾으므로 새로 추가된 바로 앞의 키만 재배치됨
- 그외에 다른 키는 재배치되지 않음

### 서버 제거
- 하나의 서버가 제거되면 키 가운데 일부만 재배치
- 서버의 왼쪽에 있던 키만 재배치 되고 나머지 키에는 영향이 없다

## 안정 해시 알고리즘 기본 구현법의 두가지 문제점
1. 서버 추가, 삭제 상황을 감안하면 파티션의 크기를 균등하게 유지하는게 불가능
- 파티션: 인접한 서버 사이의 해시 공간
- 예를들어 서버가 4개가 링위에서 균등하게 파티션을 갖고있다가, 서버 한개가 제거된다면 -> 서버 한개의 파티션만 두배의 크기를 갖게 됨

2. 키의 균등 분포 달성 어렵다
- 데이터가 서버에 불균등하게 분포될 수 있다

## 이를 해결하기 위한 기법 "노드"

### 가상노드
- 실제 노드 or 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러개의 가상 노드를 가질 수 있다
- 서버 한개는 큰 값의 노드 개수를 가진다
- 그러므로 서버는 여러개의 파티션을 관리하게 된다
- 키의 위치로 부터 링을 시계방향으로 탐색하다 만나는 최초의 가상 노드에 키가 저장된다
- 가상 노드의 개수를 늘리면 표준편차가 작아져 데이터가 고르게 분포된다

## 안정 해시의 장점
- 서버 추가 or 삭제 시 재배치 되는 키의 수가 최소화
- 데이터가 보다 균등 배포 -> 수평적 규모 확장성을 달성하기 쉽다
- 핫스팟 키 문제를 줄인다

@ 느낀점: 노드에 대해 예전에 공부한 적이 있는데 이제서야 이해가 되었다. 훨씬 이해가 쉽고 재미있었다. 

# 논의주제
분산구조라면 기능별로 데이터베이스를 나누게 되는데,

그렇다면, 서버는 부하가 많을것 같은 주제를 기준으로 나누어야 하는걸까?

MSA에서 서비스와 서버는 별개로 나눠지는걸까?
