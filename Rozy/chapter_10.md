# chapter 10 알림 시스템 설계

알림시스템: 모바일 푸시 알림, SMS 메세지, 이메일

## 1딘계
- 어떤 종류의 알림인지,
- 실시간 시스템 인지
- 어떤 종류의 단말기 지원하는지
- 서버 / 클라이언트 누가 만드는지
- 사용자가 알림을 설정할 수 있는지
- 하루에 몇 건의 알림을 보낼 수 있는지

질문을 통해 요구사항을 스스로 알아낸다

## 2단계: 개략적 설계안 제시 및 동의 구하기
### 동작 방법
 - 알림 제공자 -> APNS -> iOS 단말
 - 알림 제공자: 알림요청을 만들어 APNS에 보내는 주체
 - 요청에 필요한 데이터
   - 단말 토큰: 알림 요청을 보내는 데 필요한 고유 식별자
   - 페이로드: 알림 내용을 담은 JSON 

안드로이드는 푸시알림 서비스가 FCM(Firebase Cloud Messaging)

### 연락처 정보 수집 절차
- 모바일 단말 토큰, 전화 번호, 이메일 등의 정보를 데이터베이스에 저장해야 한다
- 1 : N  한 사람이 여러개의 단말기를 소유할 수 있기 때문에 Device 정보 테이블을 따로 둔다
- 알림은 모든 단말기에 전송되어야 하기 때문이다

### 알린 전송 및 수신 절차
- 알림 서비스의 서버가 한 개인 경우 위험
- SPOF: 그 서버에 장애가 생길 경우 전체 서비스의 장애로 이어짐ㄴ다
- 규모 확장성: 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다
- 개략적 설계

<img width="339" alt="스크린샷 2023-08-25 오전 10 28 02" src="https://github.com/Suzzzzzy/Book_Study/assets/97580836/fb8f9674-1dce-40c1-91b8-5ba1df43768f">

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리 -> 수평적 규모 확장 가능
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다
  - 알림을 병렬 처리 가능
  - 메시지 큐는 다량의 알림이 전송되어야 하는 경우 버퍼역할도 가능
  - 하나에 장애가 발생해도 나머지 알림은 정상 작동

### 상세 설계
- 분산 환경에서 고려해야하는 안전성!
- 알림이 여러번 가는 것보다 알림이 누락되는 것이 더 위험
  - 데이터 손실 방지를 위해 알림 시스템은 데이터를 저장하고 **재시도 메커니즘**을 구현해야 한다
- 중복 방지 메커니즘: 알림을 확인하고 이벤트 ID를 검사하여 이전에 보낸 이력을 확인한다
- 전송률 제한: 너무 많은 알림이 가지 않도록 알림 빈도 제한
- 재시도 방법: 알림 서비스가 전송에 실패하면 해당 알림을 재시도 전용 큐에 넣어 개발자에게 통지
- 보안: 인증된 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있어야 한다
- 
