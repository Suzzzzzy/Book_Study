# chapter 12 채팅 시스템 설계
- 클라이언트들로부터 메세지 수신
- 메시지 수신자 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메세지 보관

## 메세지 수신
HTTP는 클라이언트가 연결을 만드는 프로토콜이며, 서버에서 클라이언트로 임의 시점에 메시지를 보내는 데는 쉽게 쓰일 수 없다.

서버가 연결을 만드는 것처럼 동작하도록 하는 방법에는 폴링, 롱 폴링, 웹소켓 등이 있다

### 폴링
- 클라이언트가 주기적으로 서버에게 메세지가 있냐고 물어보는 방법
- 자주할 수록 비용 증가
- 답해줄 메세지 없는 경우 낭비

### 롱 폴링
- 새 메세지가 반환되거나, 타임아웃이 될 때까지 연결 유지
- 클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내 다시 시작
- 단, 메시지를 받은 서버는 해당 메시지를 수신할 클라이언트와 롱 폴링 연결을 가지고 있지 않은 서버일 수도 있다
- 또한 서버 입장에서는 클라이언트가 연결을 해제했는지 알 방법이 없다

### 웹소켓
- 클라이언트에게 비동기 메시지를 보내는 방법
- 클라이언트가 웹소켓 연결 시작
- 연결은 항구적, 양방향
- 첫 연결은 HTTP 연결이지만 특정 핸드셰이크 절차를 거쳐 웹소켓 연결로 업그레이드
- HTTP or HTTPS 프로토콜이 사용하는 기본 포트번호를 그대로 사용하기 때문에 방화벽 환경에서도 잘 동작

## 채팅 시스템
채팅 시스템은 무상태 서비스, 상태유지 서비스, 제 3자 서비스 연동 세 부분으로 나누어 볼 수 있다

### 무상태 서비스
- 로그인, 회원가입, 사용자 프로필 표시 등을 처리하는 전통적인 요청/응답 서비스
- 로드밸런서 뒤에 위치

### 상태 유지 서비스
- 채팅서비스만 상태유지 필요
- 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야하기 때문
- 무상태 서비스에 위치한 '서비스 탐색 서비스'가 특정 서버에 부하가 몰리지 않도록 해준다

### 제 3자 서비스 연동
- 앱이 실행 중이 아니더라도 채팅 알림을 받아야 한다

### 저장소
1. 관계형 데이터 베이스
  - 안정성 보장 필요
  - 사용자의 프로필, 설정, 친구목록 등 일반적인 데이터 저장

2. 키-값 저장소
  - 많은 양의 데이터
  - 수평적 규모 확장 용이
  - 접근 지연시간 낮음
  - 읽기:쓰기 = 1:1

* 1:1 채팅을 위한 메시지 테이블
  * 기본 키는 message_id - 메시지 순서도 정할수 있어야 함
  * 메시지가 동시에 만들어질 수도 있기 때문에 created_at으로 순서를 정할 순 없다

* 그룹 채팅을 위한 메시지 테이블
  * channel_id, message_id 복합키를 기본키로 사용

### 서비스 탐색
- 클라이언트에게 적합한 채팅 서버를 추천하는 것
- 널리 쓰이는 오픈소스 솔루션: 아파치 주키퍼

## 메시지 흐름

### 1:1 메시지 흐름
- 사용자 A가 채팅 서버 1로 메시지 전송
- 채팅 서버 1은 ID생성기를 사용해 해당 메시지의 ID결정 -> 메시지 동기화 큐로 전송
- 메시지가 키-값 저장소에 보관
- B가 접속중일 경우에는 B가 접속한 채팅서버로 전송
- B가 접속중이 아닐경우 푸시 알림 서버로 전송

### 여러 단말 사이의 메시지 동기화
- 각 단말은 cur_max_message_id 변수 유지
- 해당 단말에서 관측된 가장 최신의 메시지의 ID를 추적하는 용도
- 새 메시지란, 수신자 ID와 로그인한 ID가 같고 / 그 ID가 저장된 cur_max_message_id 보다 클 경우

### 소규모 그룹 채팅에서의 메시지 흐름
- 다른 사용자들의 메시지 동기화 큐에 메시지가 복사됨
- 새로운 메시지 확인은 본인의 큐 확인으로 가능 - 동기화 플로우 단순
- 그룹이 크지 않으면 수신자별로 복사해서 큐에 넣는 작업은 비용문제가 안됨

## 접속 상태

### 접속 상태 표시
- 사용자의 로그인, 로그아웃으로 표시
- heartbeat 검사를 통해 접속 상태 서버로 보냄


# 논의주제
상태 정보를 전송하는 부분에서, '접송상태 서비스를 구독' 한다는 것은 어떤것인가요? 50명의 그룹채팅일 경우 접속상태 서비스는 총 50^50 (50의 50제곱)개가 생기는 것이 맞나요??