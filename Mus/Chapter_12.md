[ToC]

## 함께 논의하고 싶은 주제
- 채팅 자체로는 큰 기능이 없다 생각하지만, 어떤 기능을 붙이냐에 따라서 기본 설계가 많이 바뀔 것 같습니다. 우리 서비스의 경우에는 사물에 대한 채팅과 기본 1:1 채팅의 기능이 조금 달라야 할 것 같은데, 설계가 다르다면 어떻게 다르고, 다르지 않다면 어떤 기능을 추가하는게 서비스적으로 좋을지, 설계는 어떻게 바꿔야 할 지 의논해보고 싶습니다.

## 12장 - 채팅 시스템 설계

### 1단계 - 문제 이해 및 설계 범위 확정
- 채팅앱도 상황에 따라서 다르게 설계되어야 함
  - 위챗, 왓츠앱은 1:1 채팅에 집중
  - 슬랙은 그룹 채팅에 집붕
  - 디스코드는 대규모 그룹 소통과 응답지연이 낮은 음성 채팅에 집중
- 기능리스트
  - 응답지연 낮음
  - 최대 100명까지 그룹 채팅
  - 사용자의 접속상태 표시 기능
  - 다양한 단말 지원, 하나의 계정으로 다양한 단말 동시 접속
  - 푸시 알림

### 2단계 - 개략적 설계안 제시 및 동의 구하기
- 클라이언트들로부터 메시지 수신
- 메시지 수신자 결정 및 전달
- 수신자 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관
- 서버 연결 만드는 방법
  - 폴링
    - 주기적으로 서버에서 새메시지가 있느냐고 물어봄
    - 답해줄 메시지가 없는 경우 서버 자원 낭비
  - 롱폴링
    - 새 메시지가 반환되거나 타임아웃 될 떄까지 연결을 유지
    - 클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작
    - 약점
      - 메시지를 보내는 클라이언트와 수신하는 클라이언트가 다른 채팅서버에 접속할 수 있음
      - 클라이언트가 언제 연결을 해제했는지 서버는 알 수 없음
      - 메시지를 많이 받지 않는 클라이언트 대상으로 여전히 비효율적임
  - 웹소캣
    - 우리는 이걸 씀!! 
    - 비동기
    - 항구적인 연결? -> 원서에는 뭐라고 되어 있나요???? 대충 무슨 느낌인지는 알겠는데..
    - 메시지 받을 때, 보낼 떄 같은 프로토콜을 사용
    - 설계 & 구현이 단순
- 개략적 설계안
  - 무상태 서비스
    - 로드밸런서 뒤에 위치
    - 그림 12-7 참고
  - 상태 유지 서비스
    - 채팅서비스가 유일
  - 제3자 서비스 연동
    - 푸시 알림
  - 규모 확장성
    - 채팅 서버는 클라이언트 사이에 메시지를 중계하는 역할을 담당
    - 접속상태 서버는 상용자의 접속 여부 관리
    - API 서버는 로그인, 회원가입, 프로파일 변경 등 그 외 나머지 전부를 처리
    - 알림 서버는 푸시 알림
    - 키-값 저장소에서 채팅 이력을 보관
  - 저장소
    - 채팅 시스템이 다루는 데이터는 두가지
      - 일반적 데이터: 사용자 프로파일, 설정, 친구목록
      - 고유한 데이터: 채팅 이력
        - 데이터 양이 엄청남
        - 최근에 메시지가 주로 사용
        - 검색이 가능해야함
        - 읽기 쓰기 비율이 보통 1:1
    - 키값 저장소 모델을 추천
      - 규모 확장이 쉬움
      - 데이터 접근 지연시간이 낮음
      - 관계형 데이터베이스는 인덱스카 커지면 데이터대한 무작위적 접근을 처리하는 비용이 늘어남
- 데이터 모델
  - 1:1 채팅을 위한 메시지 테이블
  - 그룹 채팅을 위한 메시지 테이블
    - 채널 id 추가
  - 메시지 id 
    - 고유해야함
    - 새로운 id는 이전것보다 큰 값

### 3단계 - 상세 설계
- 서비스 탐색
  1. 로그인 시도
  2. 로드밸런서가 API 서버 하나에게 요청
  3. API 서버가 처리 끝내면 서비스 탐색 기능이 동작
  4. 사용자는 웹소캣과 연결
- 메시지 흐름
  - 1:1 채팅 메시지 흐름
    1. 메시지 전송
    2. 채팅 서버는 메시지 ID 결정
    3. 메시지 동기화 큐로 전송
    4. 메시지가 키-갓 저장소에 보관
    5. 접속중이지 않을 경우, 푸시 알림 서버로 보냄
    6. 접속중이면 웹소캣을 이용하여 메시지 전송
  - 여러 단말 사이의 메시지 동기화
    - 수신자 ID가 현재 로그인한 사용자 ID와 같음
  - 소규모 그룹 채팅에서의 메시지 흐름
    - 사용자 별로 메시지 동기화 큐에 복사
      - 자신의 큐만 보면 되니까 플로우가 단순
      - 그룹이 크지 않으면 수신자별로 복사에서 큐에 넣는 작업 비용이 크지 않음
      - 위챗이 이거씀
- 접속상태 표시
  - 사용자 로그인
    - 마지막 액티브 타임 스탬프값을 상태와 키값 저장소에 저장
  - 로그아웃
    - 키값 저장소에서 상태를 오프라인으로 변경
  - 접속장애
    - 헐트빗트
  - 상태 정보의 전송
### 4단계 - 마무리
추카포카 :tada::tada::tada:
- 논의해보면 좋을 것 
  - 미디어 지원
  - 암호화
  - 캐시
  - 로딩 속도 개선
  - 오류 처리