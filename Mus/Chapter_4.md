[ToC]

## 4장 - 처리율 저장 장치의 설계

### 1단계 - 문제 이해 및 설계 범위 확정
- 처리율 저장 장치를 설계하는데 다양한 알고리즘을 사용할 수 있음
- 소통을 통해 어떠한 장치를 구현할지 정함
- 요구 사항을 요약

### 2단계 - 개략적 설계안 제시 및 동의 구하기
- 처리율 제한 장치는 어디에 둘 것인가?
  - 클라이언트는 젠젠쟈나이
  - 서버측에 둬야함
  - 미들웨어에 둘 수 있지만...
  - 클라우드 마이크로서비스의 경우, 처리율 제한 장치는 보통 [API 게이트웨이](./Glossary.md#4장)라 불리는 컴포넌트에 구현
  - 어디에 둘지 정하는 몇가지 지침
    - 기술언어
    - 알고리즘 찾기
    - 설계에 맞추기
    - 구현 리소스가 없으면 API 게이트웨이 써라
- 처리율 제한 알고리즘
  - 토큰 버킷(token bucket)
    - 이해하기 쉬워서 가장 많이 씀
    - 동작원리(3줄 요약)
      - 버킷 용량을 지정하고
      - 버킷에 토큰을 담아서 하나씩 빼서 처리하다가
      - 가득 차면 버림
    - 2개 파라미터
      - 버킷 크기
      - 토큰 공급률: 초당 몇 개의 토큰이 버킷에 공급되는가
    - 장점
      - 쉬움
      - 메모리 사용 측면 효율적
      - 짧은 시간에 집중되는 트레픽(burst of traffic)도 처리 가능
    - 단점
      - 2개 파라미터를 적적하게 튜닝하는 것은 까다로움
  - 누출 버킷(leacy bucket)
    - 토큰 버킷과 비슷하지만 FIFO 큐로 구현
    - 동작원리(3줄 요약)
      - 큐에 빈자리 있으면 요청 추가하고
      - 가득차 있으면 요청 버리면서
      - 처리 시간마다 큐에서 요청을 꺼내서 처리
    - 2개의 파라미터
      - 버킷 크기
      - 처리율
    - 장점
      - 메모리 사용량 측면에서 효율적
      - 고정된 처리율 -> 안정적 츌력
    - 단점
      - 트래픽 몰리면 요청 버려지는게 많음
      - 튜닝 까다로움
  - 고정 윈도 카운터(fixed window counter)
    - 타임라인을 고정된 간격의 윈도로 나누고 각 윈도에 카운터를 붙임
    - 요청이 접수될 때 카운터 1증가
    - 임계지를 넘으면 새 윈도가 열릴때 까지 요청을 버림
    - 트래픽이 몰리면 할당된 윈도우 보다 더많은 요청을 받음
    - 장점
      - 메모리 효율이 좋음
      - 이해하기 쉬움
      - 특정 트래픽 패턴을 처리하기 좋음
    - 단점
      - 일시적으로 많은 트래픽이 몰리면 처리 한도보다 더많은 트래픽 처리
  - 이동 윈도 로그(sliding window log)
    - 타임스탬프를 추첮
    - 만료된 타임스탬프 제거
    - 새 요청의 타임스탬프를 로그에 추가
    - 로그의 크기가 허용치보다 같거나 작으면 요청을 처리
    - 장점
      - 매우 정교함
    - 단점
      - 거부된 요청의 타임스탬프도 보관하여 다량의 메모리를 샤용
  - 이동 윈도 카운터(sliding window counter)
    - 고정 윈도 카운터 알고리즘과 이동 윈도 로깅 알고리즘을 결합
    - 장점
      - 메모리 효율이 좋음
      - 짧은 시간에 몰리는 트래픽에도 잘 대응
    - 단점
      - 균등하게 요청하면 추정치를 계산하기 떄문에 다소 느슨 -> 무슨 말인지 모르겠습니당
        - 심각하지 않음
  - 개략적인 아키텍처

### 3단계 - 상세 설계
- 처리율 제한 규칙
- 처리율 한도 초과 트래픽 처리
- 상세 설계
- 분산 환경에서의 처리율 제한 장치의 구현
  - 경쟁 조건
  - 동기화 이슈
  - 성능 최적화
  - 모니터링

### 4단계 - 미무리
- 경성 연성 처리율 제한
- 다양한 계층에서 처리율 제한 -> OSI 7계층
- 처리율 제한을 회피하는 방법
  

## 함께 논의하고 싶은 주제
- 이렇게 많은 것을 고려하여 처리율 저장 장치를 설계하는게 보편적인지?? 여기 나온대로라면 그냥 이동 윈도 카운터가 좋은 것 같은데 이렇게 구현하는게 쉽지 않을 것 같습니다.