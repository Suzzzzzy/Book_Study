## CHAPTER 11: DESIGN A NEWS FEED SYSTEM

```
논의내용)
여태까지 시스템 설계 내용을 보면 핵심적인 내용들이 있는데 캐시, 메시지 큐 인 것 같습니다.
그리고 논의할 내용이 점점 없어지는 것 같기도 합니다.
설계가 이렇다 라고 설명하는 식이다 보니 자연스럽게 비판적이기 보다는 받아들이는 수준으로 가고 있네요.
```

뉴스 피드(news feed)는 페이스북 도움말 페이지를 인용하면 다음과 같다.

"뉴스 피드는 여러분의 홈 페이지 중앙에 지속적으로 업데이트되는 스토리들로, 사용자 상태 정보 업데이트 사진, 비디오, 링크, 앱 활동, 그리고 여러분이 페이스북에서 팔로하는 사람들 페이지, 또는 그룹으로부터 나오는 '좋아요' 등을 포함한다"

### 1단계 문제 이해 및 설계 범위 확정

뉴스 피드 시스템 설계는 면접관의 의도가 무엇인지 알아내는 것이다. 최소 어떤 기능을 지원해야 할지 파악이 필요하다.

- 모바일 앱과 웹 둘다 지원
- 핵심 기능: 뉴스 피드 페이지에 새로운 스토리 등록, 친구들이 올리는 스토리도 볼 수 있어야 함
- 스토리 표시 순서: 시간 흐름 역순(reverse chronological order)
- 최대 친구: 5000명
- 트래픽 양: 매일 천만 명 방문 (10million DAU)
- 스토리는 이미지나 비디오 등의 미디어 파일 포함 가능

### 2단계 개략적 설계안 제시 및 동의 구하기

설계는 두 파트로 나눠져 있다.

- 피드 발행(feed publishing): 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록. 새 포스팅은 친구의 뉴스 피드에도 전송됨.
- 뉴스 피드 생성(news feed building): 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다고 가정

#### 뉴스 피드 API

##### 피드 발행 API

새 스토리를 포스팅

POST /v1/me/feed
params:

- 바디: 포스팅 내용
- Authorization 헤더: API 호출을 인증하기 위해 사용

##### 피드 읽기 API

뉴스 피드를 가져오는 API

GET /v1/me/feed
Params:

- Authorization 헤더: API 호출을 인증하기 위해 사용

#### 피드 발행

시스템의 개략적 형태는 다음과 같다.

<img width="294" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/e14b8cc6-9f58-4a1f-842d-db089869ef7d">

- 사용자: 앱이나 웹에서 포스팅을 올리는 주체, POST /v1/me/feed 사용
- 로드밸런서: 트래픽을 웹 서버들로 분산
- 웹 서버: HTTP 요청을 내부 서비스로 중계
- 포스팅 저장 서비스(post service): 새 포스팅을 데이터베이스와 캐시에 저장
- 포스팅 전송 서비스(fanout service); 새 포스팅을 친구의 뉴스 피드에 푸시한다. 뉴스 피드 데이터는 캐시에서 빠르게 읽을 수 있게 한다.
- 알림 서비스(notifiation service): 친구들에게 새 포스팅이 올라왔음을 알리거나, 푸시 알림을 보내는 역할을 담당한다.

#### 뉴스 피드 생성

사용자가 보는 뉴스 피드가 어떻게 만들어지는지 개략적인 설계를 알아본다.

<img width="229" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/e6fde92e-ff90-4179-99ed-0da16550d2e9">

- 사용자: 뉴스 피드를 읽는 주체, GET /v1/me/feed API 이용
- 로드 밸런서: 트래픽을 웹 서버들로 분산
- 웹 서버: 트래픽을 뉴스 피드 서비스로 보낸다.
- 뉴스 피드 서비스(news feed service): 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시(news feed cache): 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관

### 3단계 상세 설계

#### 피드 발행 흐름 상세 설계

아래 그림은 피드 발행 흐름의 상세 설계이다. 웹 서버와 포스팅 전송 서비스(fanout service)에 초점을 둔다.

<img width="465" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/469af0b7-6327-4aa5-ad6f-a3c04beb231c">

##### 웹 서버

클라이언트와 통신 이외에 인증이나 처리율 제한 등의 기능도 수행한다.
올바른 인증 토큰이 헤더에 있는 요청만 포스팅 할 수 있게 처리해야 한다.
또 스팸과 유해 콘텐츠를 방지하기 위해 특정 기간에 한 사용자가 올릴 수 있는 포스팅 수에 대한 제한도 걸어야 한다.

##### 포스팅 전송(팬아웃) 서비스

어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.
팬 아웃에는 두 가지 모델이 있다.

쓰기 시점에 팬아웃하는 모델: 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신한다. 즉, 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록한다.

장점

- 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송
- 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로(pre-computed) 뉴스 피드를 읽는데 드는 시간이 짧아진다.

단점

- 친구가 많은 사용자의 경우 모든 친구의 뉴스 피드를 갱신하는데 많은 시간이 소요될 수 있다. 핫키(hotkey)라고도 부르는 문제다.
- 서비스를 많이 이용하지 않는 사용자의 피드도 갱신해야 하므로 컴퓨팅 자원이 낭비된다.

읽기 시점에 팬아웃 하는 모델: 피드를 읽어야 하는 시점에 뉴스 피드를 갱신한다. 즉 요청 기만(on-demand) 모델이다. 자신의 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져오게 된다.

장점

- 비활성화된 사용자나 서비스에 거의 로그인하지 않는 사용자의 경우는 이 모델이 유리하다. 로그인 하기 전까지 컴퓨팅 자원을 소모하지 않는다.
- 데이터를 친구들에게 푸시하는 작업이 필요가 없으므로 핫키 문제가 없다.

단점

- 뉴스 피드를 읽는 데 많은 시간이 소요된다.

여기서는 두 가지 방법을 결합해서 장점을 취하고 단점을 버리는 전략을 가져간다.

- 뉴스 피드를 빠르게 가져오는 건 중요한 기능이므로 푸시 모델을 사용한다.
- 친구나 팔로어가 많은 사용자의 경우에는 팔로어들의 포스팅이 필요할 때 가져오는 풀 모델을 사용해 시스템 과부하를 줄인다.
- 안정 해시를 통해 요청과 데이터를 보다 고르게 분산하여 핫키 문제를 줄인다.

아래 그림은 팬아웃 서비스만 따로 자세히 만든 것이다.

<img width="351" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/c1ae7745-52cf-429e-be71-d3474a4791ec">

이 서비스의 동작은 다음과 같다.

1. 그래프 데이터베이스에서 친구 ID 목록을 가져온다. 그래프 데이터베이스는 친구 관계나 친구 추천을 관리하기 적합하다.
2. 사용자 정보 캐시에서 친구들의 정보를 가져온다. 그 중에 피드 업데이트 무시 설정을 한 친구의 경우는 뉴스 피드가 업데이트 되지 않는다. 새로 포스팅된 스토리가 일부 사용자에게만 공유되도록 설정하는 것도 비슷하다.
3. 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
4. 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다. 뉴스 피드 캐시는 < 포스팅 ID, 사용자 ID>의 순서쌍을 보관하는 매핑 테이블이다. 사용자 정보나 포스팅 정보를 이 테이블에 저장 안하는 이유는 메모리 요구량이 많을 수 있기 때문에 ID만 보관한다. 또 메모리 크기를 적정 수준을 유지하기 위해 캐시 크기에 제한을 두고 조정 가능하도록 한다. 보통 뉴스 피드에 수천개의 스토리를 전부 보는 일은 적고 최신 스토리를 보려 하므로 캐시 미스(cache miss)가 일어날 확률은 낮다.

#### 피드 읽기 흐름 상세 설계

뉴스 피드를 읽는 과정 전반의 상세 설계안은 아래 그림과 같다.

<img width="399" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/331d1cd7-0d0d-4799-b435-15a6f9550b1b">

이미지나 비디오 같은 미디어 콘텐츠는 CDN에 저장해서 빨리 읽을 수 있게 한다.
클라이언트가 뉴스 피드를 어떻게 읽어 가는지 알아본다.

1. 사용자가 뉴스 피드를 읽으려는 요청을 보낸다. /v1/me/feed로 전송된다.
2. 로드밸런서가 요청을 웹 서버 중 하나로 보낸다.
3. 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출한다.
4. 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록을 가져온다.
5. 뉴스 피드에 표시할 사용자 이름, 사용자 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 가져와 완전한 뉴스 피드를 만든다.
6. 생성된 뉴스 피드를 JSON 형태로 클라이언트에 보내면, 해당 피드를 렌더링 한다.

#### 캐시 구조

캐시는 뉴스 피드 시스템의 핵심 컴포넌트다. 아래 그림처럼 다섯 계층으로 나눈다.

<img width="455" alt="image" src="https://github.com/jongfeel/BookReview/assets/17442457/4573cca8-ed5b-42df-a6ac-be0ec7cb2e56">

- 뉴스 피드: 뉴스 피드 ID 보관
- 콘텐츠: 포스팅 데이터 보관, 인기 콘텐츠의 경우 따로 보관
- 소셜 그래프: 사용자 간 관계 정보
- 행동(action): 포스팅에 대해 좋아요나 답글 등의 행위에 관한 정보
- 횟수(counter): 좋아요, 응답, 팔로어, 팔로잉 수 등의 정보

#### 4단계 마무리

설계를 진행하고 기술을 선택할 때는 그 배경에 어떤 타협적 결정들(trade-off)이 있었는지 잘 이해하고 설명할 수 있어야 한다.
면접관과 규모 확장성 이슈를 논의하는 것도 좋다. 다루면 좋을 만한 주제 몇 가지는 아래와 같다.

데이터베이스 규모 확장

- 수직 vs 수평
- SQL vs NoSQL
- Master-slave 다중화
- 복제본(replica)에 대한 읽기 연산
- 일관성 모델(consistency model)
- 데이터베이스 샤딩(sharding)

이 외에도 논의해 볼 만한 주제는 다음이 있다.

- 웹 계층을 무상태로 운영하기
- 가능한 한 많은 데이터를 캐시하는 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭(key metric)에 대한 모니터링. 트래픽이 몰리는 시간대의 QPS(Queries per Second), 사용자가 뉴스 피드를 새로고침할 떄 지연시간 등